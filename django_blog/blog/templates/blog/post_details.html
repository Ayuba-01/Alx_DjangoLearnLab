{% extends "blog/base.html" %}
{% block title %}{{ post.title }} — My Blog{% endblock %}

{% block content %}
<article>
    <h1>{{ post.title }}</h1>
    <small>by {{ post.author.username }} · {{ post.created_at|date:"M d, Y H:i" }}</small>
    {% if post.tags.all %}
      <div class="tags" style="margin:.5rem 0 1rem;">
        {% for t in post.tags.all %}
          <a href="{% url 'blog:posts-by-tag' t.slug %}" class="tag">#{{ t.name }}</a>
        {% endfor %}
      </div>
    {% endif %}
    <div class="post-body">
      {{ post.content|linebreaks }}
    </div>
  </article>

  <section id="comments" style="margin-top:2rem;">
    <h2>Comments ({{ comments|length }})</h2>

    {% if comments %}
      <ul class="comments" style="list-style:none; padding-left:0;">
        {% for c in comments %}
          <li id="comment-{{ c.pk }}" style="margin:1rem 0; padding:1rem; border:1px solid #eee; border-radius:8px;">
            <div class="meta" style="font-size:.9rem; color:#666;">
              by {{ c.author.username }} · {{ c.created_at|date:"M d, Y H:i" }}
              {% if c.updated_at and c.updated_at > c.created_at %}
                · <em>edited</em>
              {% endif %}
            </div>
            <p style="margin:.75rem 0 0;">{{ c.content|linebreaks }}</p>

            {% if request.user.is_authenticated and request.user.id == c.author_id %}
              <div style="margin-top:.5rem;">
                <a href="{% url 'blog:comment-edit' c.pk %}">Edit</a>
                ·
                <a href="{% url 'blog:comment-delete' c.pk %}">Delete</a>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No comments yet.</p>
    {% endif %}

    {% if request.user.is_authenticated %}
      <h3 style="margin-top:2rem;">Leave a comment</h3>
      <form method="post" action="{% url 'blog:comment-create' post_id=post.pk %}" novalidate>
        {% csrf_token %}
        {{ comment_form.non_field_errors }}
        {% for field in comment_form %}
          <div class="form-row" style="margin:.75rem 0;">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% for err in field.errors %}<p class="error">{{ err }}</p>{% endfor %}
            {% if field.help_text %}<small class="help">{{ field.help_text|safe }}</small>{% endif %}
          </div>
        {% endfor %}
        <button type="submit">Post comment</button>
      </form>
    {% else %}
      <p style="margin-top:1rem;">
        <a href="{% url 'blog:login' %}?next={{ request.path }}">Log in</a> to comment.
      </p>
    {% endif %}
  </section>

  <p style="margin-top:1.5rem;"><a href="{% url 'blog:post-list' %}">← Back to posts</a></p>
{% endblock %}
